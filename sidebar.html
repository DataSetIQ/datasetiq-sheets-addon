<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>DataSetIQ</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');
      :root {
        color-scheme: light;
        --bg: #f5f7fb;
        --panel: #ffffff;
        --border: #e4e8f1;
        --text: #0f172a;
        --muted: #4b5563;
        --accent: #0b63f6;
        --accent-soft: #dfeafe;
        --positive: #12b76a;
        --shadow: 0 12px 30px -14px rgba(15, 23, 42, 0.35);
        --radius: 14px;
      }
      body {
        font-family: 'Space Grotesk', 'Segoe UI', system-ui, -apple-system, sans-serif;
        margin: 0;
        padding: 16px;
        max-width: 420px;
        box-sizing: border-box;
        background: radial-gradient(circle at 20% 20%, #e8f0ff 0, rgba(232,240,255,0) 30%), radial-gradient(circle at 90% 10%, #dff5ff 0, rgba(223,245,255,0) 25%), var(--bg);
        color: var(--text);
      }
      h2 {
        margin: 0 0 6px;
        font-size: 20px;
        letter-spacing: -0.02em;
      }
      .brand-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 12px;
      }
      .eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 2px;
      }
      .card {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 14px;
        margin-bottom: 14px;
        background: var(--panel);
        line-height: 1.5;
        box-shadow: var(--shadow);
      }
      label {
        display: block;
        font-weight: 600;
        margin-bottom: 4px;
        color: var(--text);
      }
      input[type='text'] {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 10px;
        box-sizing: border-box;
        margin-bottom: 8px;
        background: #f9fbff;
        font-size: 14px;
      }
      button {
        border: none;
        border-radius: 10px;
        background: var(--text);
        color: #fff;
        padding: 10px 14px;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: -0.01em;
      }
      button.secondary {
        background: #eef1f6;
        color: var(--text);
      }
      .muted {
        color: var(--muted);
        font-size: 12px;
        margin-top: 4px;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .status {
        margin: 0 0 12px 0;
        padding: 12px;
        font-size: 13px;
        line-height: 1.5;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
        background: #ecfdf3;
        border: 1px solid #baf0cf;
        border-radius: 12px;
        color: #05603a;
        font-weight: 600;
        box-shadow: var(--shadow);
      }
      .status.error {
        background: #fef2f2;
        border-color: #fca5a5;
        color: #b91c1c;
      }
      .quota {
        font-size: 12px;
        color: var(--text);
      }
      ul {
        padding: 0;
        margin: 8px 0;
        list-style: none;
      }
      li {
        margin-bottom: 8px;
      }
      .result-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #f9fbff;
        box-shadow: 0 6px 18px -12px rgba(15, 23, 42, 0.45);
      }
      .result-id {
        font-weight: 700;
        font-size: 13px;
        word-break: break-word;
        color: var(--text);
      }
      .result-title {
        font-size: 12px;
        color: #667085;
        line-height: 1.4;
        margin-top: 4px;
      }
      .result-buttons {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(42px, 1fr));
        gap: 8px;
        align-items: center;
        width: 100%;
      }
      .icon-btn {
        background: var(--text);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 0;
        font-size: 16px;
        cursor: pointer;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        box-shadow: 0 6px 16px -10px rgba(15, 23, 42, 0.55);
      }
      .icon-btn:hover {
        background: #1b2437;
      }
      .insert-btn {
        background: var(--accent);
        color: #fff;
        padding: 8px 12px;
        font-size: 11px;
        border-radius: 10px;
        white-space: nowrap;
        cursor: pointer;
        font-weight: 600;
      }
      .insert-btn:hover {
        background: #0a54d6;
      }
      .fav-btn {
        background: linear-gradient(135deg, #f7b500 0%, #e69700 100%);
        color: #fff;
        padding: 6px 10px;
        font-size: 14px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        border: none;
      }
      .fav-btn:hover {
        filter: brightness(0.96);
      }
      .tabs {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(88px, 1fr));
        gap: 8px;
        padding: 10px;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: var(--panel);
        box-shadow: var(--shadow);
        margin-bottom: 12px;
      }
      .tab {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 6px;
        background: #f6f8fc;
        color: #465467;
        padding: 10px 6px;
        font-size: 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
      }
      .tab.active {
        color: var(--text);
        border-color: var(--accent);
        box-shadow: 0 8px 16px -12px rgba(11, 99, 246, 0.6);
        background: #eef3ff;
      }
      .tab:hover {
        background: #edf1f7;
      }
      .preview-btn {
        background: #8b5cf6;
        color: #fff;
        padding: 6px 10px;
        font-size: 14px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        border: none;
      }
      .preview-btn:hover {
        background: #7c3aed;
      }
      .preview-item {
        margin-bottom: 10px;
        font-size: 13px;
      }
      .preview-item strong {
        color: #475569;
        display: block;
        margin-bottom: 4px;
        font-size: 11px;
      }
      .result-buttons.compact-icons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(42px, 1fr));
        gap: 8px;
      }
      .result-buttons.compact-icons button {
        width: 44px;
        height: 44px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        border-radius: 10px;
      }
    </style>
    <script>
      let currentStatus = null;
      let activeTab = 'search';
      let favorites = [];
      let recent = [];
      let sources = [];
      let browseResults = [];
      let previewSeries = null;
      let previewData = null;
      let isPaid = false;
      let selectedForMultiInsert = [];
      let builderStep = 1;
      let builderConfig = { functionName: 'DSIQ', seriesId: '', freq: '', startDate: '' };
      let templates = [];
      let scannedFormulas = [];

      function onLoad() {
        refreshStatus();
        loadFavoritesAndRecent();
        loadSources();
      }
      
      function showPreview(seriesId) {
        previewSeries = seriesId;
        document.getElementById('preview-modal').style.display = 'flex';
        document.getElementById('preview-title').innerText = seriesId;
        document.getElementById('preview-body').innerHTML = '<div class="muted">Loading...</div>';
        
        google.script.run
          .withSuccessHandler((data) => {
            previewData = data;
            renderPreview();
          })
          .withFailureHandler(showError)
          .getPreviewData(seriesId);
      }
      
      function hidePreview() {
        previewSeries = null;
        previewData = null;
        document.getElementById('preview-modal').style.display = 'none';
      }
      
      function renderPreview() {
        const body = document.getElementById('preview-body');
        if (previewData?.error) {
          body.innerHTML = `<div class="muted" style="color: #b91c1c;">${previewData.error}</div>`;
          return;
        }
        
        let html = '';
        
        // Metadata-only notice
        if (previewData.isMetadataOnly) {
          html += `<div style="margin-bottom: 12px; padding: 10px; background: #fef3c7; border-radius: 6px; border: 1px solid #fbbf24;">
            <strong style="color: #92400e; display: block; margin-bottom: 4px;">üìä Metadata Only</strong>
            <p style="font-size: 12px; color: #78350f; margin: 4px 0;">
              This dataset hasn't been fully ingested yet. Click below to fetch the complete time-series data.
            </p>
            <button 
              onclick="requestFullIngestion('${previewSeries}')"
              style="margin-top: 8px; width: 100%; padding: 8px; background: #f59e0b; color: #fff; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
              üöÄ Fetch Full Dataset
            </button>
          </div>`;
        }
        
        // Ingestion pending notice
        if (previewData.isPending) {
          html += `<div style="margin-bottom: 12px; padding: 10px; background: #dbeafe; border-radius: 6px; border: 1px solid #3b82f6;">
            <strong style="color: #1e3a8a; display: block; margin-bottom: 4px;">‚è≥ Ingestion In Progress</strong>
            <p style="font-size: 12px; color: #1e40af; margin: 0;">
              ${previewData.statusMessage || 'Full dataset is being fetched. This usually takes 1-2 minutes. Please check back shortly.'}
            </p>
          </div>`;
        }
        
        html += `<div class="preview-item"><strong>Latest Value:</strong> ${previewData.latest ?? 'N/A'}</div>`;
        if (previewData.meta?.title) html += `<div class="preview-item"><strong>Title:</strong> ${previewData.meta.title}</div>`;
        if (previewData.meta?.frequency) html += `<div class="preview-item"><strong>Frequency:</strong> ${previewData.meta.frequency}</div>`;
        if (previewData.meta?.units) html += `<div class="preview-item"><strong>Units:</strong> ${previewData.meta.units}</div>`;
        if (previewData.meta?.updated) html += `<div class="preview-item"><strong>Last Updated:</strong> ${previewData.meta.updated}</div>`;
        
        html += `<div style="margin-top: 16px; display: flex; gap: 8px;">
          <button onclick="insertFormula('${previewSeries}', 'DSIQ'); hidePreview();">Insert Array</button>
          <button class="secondary" onclick="insertFormula('${previewSeries}', 'DSIQ_LATEST'); hidePreview();">Insert Latest</button>
        </div>`;
        
        body.innerHTML = html;
      }
      
      function requestFullIngestion(seriesId) {
        showStatus('Requesting full dataset ingestion...');
        google.script.run
          .withSuccessHandler((result) => {
            if (result.requiresAuth) {
              showError('‚ö†Ô∏è Authentication required. Visit datasetiq.com to sign up for full data access.');
            } else if (result.upgradeToPro) {
              showError(`‚ö†Ô∏è Monthly limit reached (${result.remaining || 0}/${result.limit || 100}). Upgrade to Pro for unlimited access.`);
            } else if (result.success) {
              showStatus('‚úÖ Dataset ingestion started! Data will be available in 1-2 minutes.');
              // Update preview to show pending status
              previewData.isPending = true;
              previewData.statusMessage = 'Dataset ingestion queued. Full data will be available shortly.';
              renderPreview();
            } else {
              showError(`‚ö†Ô∏è ${result.error || 'Failed to queue ingestion'}`);
            }
          })
          .withFailureHandler(showError)
          .requestFullIngestion(seriesId);
      }
      
      function loadSources() {
        google.script.run
          .withSuccessHandler((srcs) => {
            sources = srcs || [];
            renderSourceDropdown();
          })
          .getSources();
      }
      
      function loadFavoritesAndRecent() {
        google.script.run
          .withSuccessHandler((favs) => {
            favorites = favs || [];
            updateTabCounts();
            if (activeTab === 'favorites') showFavorites();
          })
          .getFavorites();
        google.script.run
          .withSuccessHandler((rec) => {
            recent = rec || [];
            updateTabCounts();
            if (activeTab === 'recent') showRecent();
          })
          .getRecent();
      }
      
      function updateTabCounts() {
        const favTab = document.getElementById('tab-favorites');
        const recTab = document.getElementById('tab-recent');
        if (favTab) favTab.innerText = `‚≠ê Favorites (${favorites.length})`;
        if (recTab) recTab.innerText = `üïí Recent (${recent.length})`;
      }

      function refreshStatus() {
        google.script.run
          .withSuccessHandler(renderStatus)
          .withFailureHandler(showError)
          .getSidebarStatus();
      }

      function renderStatus(status) {
        currentStatus = status;
        isPaid = !!status.isPaid;
        const banner = document.getElementById('status-banner');
        banner.classList.remove('error');
        const connected = !!status.connected;
        document.getElementById('connected-view').style.display = connected ? 'block' : 'none';
        document.getElementById('disconnected-view').style.display = connected ? 'none' : 'block';
        
        // Update Builder and Templates tabs based on isPaid
        updatePremiumTabs();
        
        if (connected) {
          banner.innerText = status.status || '‚úÖ Connected - Premium features unlocked';
          document.getElementById('user-email').innerText = status.email || 'Authenticated User';
          const planText = status.plan ? (status.plan.charAt(0).toUpperCase() + status.plan.slice(1) + ' Plan') : 'Premium Access';
          document.getElementById('user-plan').innerText = planText;
          const quota = status.quota;
          if (quota) {
            document.getElementById('user-quota').innerText = `${quota.used}/${quota.limit} (resets ${quota.reset})`;
          } else {
            document.getElementById('user-quota').innerText = '1000 observations per series';
          }
        } else {
          banner.innerText = status.error || 'üîì Free access - 100 observations per series. Connect API key for premium features.';
        }
      }
      
      function updatePremiumTabs() {
        const builderTab = document.getElementById('tab-builder');
        const templatesTab = document.getElementById('tab-templates');
        
        if (builderTab) {
          builderTab.innerText = isPaid ? 'üîß Builder' : 'üîí Builder';
          builderTab.disabled = !isPaid;
          builderTab.style.opacity = isPaid ? '1' : '0.5';
          builderTab.style.cursor = isPaid ? 'pointer' : 'not-allowed';
        }
        
        if (templatesTab) {
          templatesTab.innerText = isPaid ? 'üìÅ Templates' : 'üîí Templates';
          templatesTab.disabled = !isPaid;
          templatesTab.style.opacity = isPaid ? '1' : '0.5';
          templatesTab.style.cursor = isPaid ? 'pointer' : 'not-allowed';
        }
      }

      function saveKey() {
        const keyInput = document.getElementById('api-key');
        const key = keyInput ? keyInput.value : '';
        document.getElementById('status-banner').innerText = 'Saving...';
        google.script.run
          .withSuccessHandler(() => {
            if (keyInput) keyInput.value = '';
            refreshStatus();
          })
          .withFailureHandler(showError)
          .saveApiKey(key);
      }

      function disconnect() {
        google.script.run.withSuccessHandler(refreshStatus).withFailureHandler(showError).clearApiKey();
      }

      function search() {
        const input = document.getElementById('search-box');
        const q = input ? input.value : '';
        if (!q) return;
        document.getElementById('search-results').innerHTML = '<div class="muted">Searching...</div>';
        google.script.run.withSuccessHandler(renderResults).withFailureHandler(showError).searchSeries(q);
      }

      function renderResults(results) {
        const container = document.getElementById('search-results');
        if (!results || !results.length) {
          container.innerHTML = '<div class="muted">No results.</div>';
          return;
        }
        container.innerHTML = '';
        const list = document.createElement('ul');
        results.forEach((item) => {
          const li = document.createElement('li');
          li.className = 'result-item';
          
          const topRow = document.createElement('div');
          topRow.style.display = 'flex';
          topRow.style.alignItems = 'flex-start';
          topRow.style.gap = '8px';
          
          // Multi-select checkbox for paid users
          if (isPaid) {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = selectedForMultiInsert.includes(item.id);
            checkbox.onchange = () => toggleMultiSelect(item.id);
            checkbox.style.cursor = 'pointer';
            checkbox.style.marginTop = '2px';
            topRow.appendChild(checkbox);
          }
          
          const info = document.createElement('div');
          info.style.flex = '1';
          info.style.minWidth = '0';
          const idDiv = document.createElement('div');
          idDiv.className = 'result-id';
          idDiv.innerText = item.id;
          const titleDiv = document.createElement('div');
          titleDiv.className = 'result-title';
          titleDiv.innerText = item.title || '';
          info.appendChild(idDiv);
          info.appendChild(titleDiv);
          topRow.appendChild(info);
          
          const buttons = document.createElement('div');
          buttons.className = 'result-buttons compact-icons';
          
          const btnPreview = createPreviewButton(item.id);
          const btnArray = createInsertButton('üìä Array', item.id, 'DSIQ');
          const btnLatest = createInsertButton('üìà Latest', item.id, 'DSIQ_LATEST');
          const btnYoy = createInsertButton('üìâ YoY', item.id, 'DSIQ_YOY');
          
          buttons.appendChild(btnPreview);
          buttons.appendChild(btnArray);
          buttons.appendChild(btnLatest);
          buttons.appendChild(btnYoy);
          
          li.appendChild(topRow);
          li.appendChild(buttons);
          list.appendChild(li);
        });
        container.appendChild(list);
        
        // Show multi-insert button if items selected
        const multiBtn = document.getElementById('multi-insert-btn');
        if (multiBtn) {
          multiBtn.style.display = selectedForMultiInsert.length > 0 ? 'block' : 'none';
          multiBtn.innerText = `Insert ${selectedForMultiInsert.length} Series`;
        }
      }
      
      function createInsertButton(label, seriesId, functionName) {
        const btn = document.createElement('button');
        btn.className = 'insert-btn';
        btn.innerText = label;
        btn.title = functionName ? `Insert ${functionName} formula` : '';
        if (functionName) {
          btn.onclick = () => insertFormula(seriesId, functionName);
        }
        return btn;
      }
      
      function createPreviewButton(seriesId) {
        const btn = document.createElement('button');
        btn.className = 'preview-btn';
        btn.innerText = 'üëÅÔ∏è';
        btn.title = 'Preview data';
        btn.onclick = () => showPreview(seriesId);
        return btn;
      }
      
      function insertFormula(seriesId, functionName) {
        google.script.run
          .withSuccessHandler(() => {
            document.getElementById('status-banner').innerText = `Inserted ${functionName}(\"${seriesId}\")`;
            loadFavoritesAndRecent();
            setTimeout(() => refreshStatus(), 2000);
          })
          .withFailureHandler(showError)
          .insertFormulaIntoActiveCell(seriesId, functionName);
      }
      
      function toggleFavorite(seriesId) {
        const isFavorite = favorites.includes(seriesId);
        if (isFavorite) {
          google.script.run
            .withSuccessHandler(() => loadFavoritesAndRecent())
            .removeFavorite(seriesId);
        } else {
          google.script.run
            .withSuccessHandler(() => loadFavoritesAndRecent())
            .addFavorite(seriesId);
        }
      }
      
      function switchTab(tab) {
        // Check premium access for Builder and Templates
        if ((tab === 'builder' || tab === 'templates') && !isPaid) {
          showStatus('üîí Premium features require an API key. Visit datasetiq.com/dashboard/api-keys');
          return;
        }
        
        activeTab = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        
        if (tab === 'search') showSearch();
        else if (tab === 'favorites') showFavorites();
        else if (tab === 'recent') showRecent();
        else if (tab === 'browse') showBrowse();
        else if (tab === 'builder') showBuilder();
        else if (tab === 'templates') showTemplates();
      }
      
      function showSearch() {
        document.getElementById('search-view').style.display = 'block';
        document.getElementById('favorites-view').style.display = 'none';
        document.getElementById('recent-view').style.display = 'none';
        document.getElementById('browse-view').style.display = 'none';
        document.getElementById('builder-view').style.display = 'none';
        document.getElementById('templates-view').style.display = 'none';
      }
      
      function showFavorites() {
        document.getElementById('search-view').style.display = 'none';
        document.getElementById('favorites-view').style.display = 'block';
        document.getElementById('recent-view').style.display = 'none';
        document.getElementById('browse-view').style.display = 'none';
        document.getElementById('builder-view').style.display = 'none';
        document.getElementById('templates-view').style.display = 'none';
        renderList(favorites, 'favorites-list', true);
      }
      
      function showRecent() {
        document.getElementById('search-view').style.display = 'none';
        document.getElementById('favorites-view').style.display = 'none';
        document.getElementById('recent-view').style.display = 'block';
        document.getElementById('browse-view').style.display = 'none';
        document.getElementById('builder-view').style.display = 'none';
        document.getElementById('templates-view').style.display = 'none';
        renderList(recent, 'recent-list', false);
      }
      
      function showBrowse() {
        document.getElementById('search-view').style.display = 'none';
        document.getElementById('favorites-view').style.display = 'none';
        document.getElementById('recent-view').style.display = 'none';
        document.getElementById('browse-view').style.display = 'block';
        document.getElementById('builder-view').style.display = 'none';
        document.getElementById('templates-view').style.display = 'none';
      }
      
      function showBuilder() {
        document.getElementById('search-view').style.display = 'none';
        document.getElementById('favorites-view').style.display = 'none';
        document.getElementById('recent-view').style.display = 'none';
        document.getElementById('browse-view').style.display = 'none';
        document.getElementById('builder-view').style.display = 'block';
        document.getElementById('templates-view').style.display = 'none';
        builderStep = 1;
        renderBuilderStep();
      }
      
      function showTemplates() {
        document.getElementById('search-view').style.display = 'none';
        document.getElementById('favorites-view').style.display = 'none';
        document.getElementById('recent-view').style.display = 'none';
        document.getElementById('browse-view').style.display = 'none';
        document.getElementById('builder-view').style.display = 'none';
        document.getElementById('templates-view').style.display = 'block';
        loadTemplatesList();
      }
      
      function renderBuilderStep() {
        const container = document.getElementById('builder-container');
        if (builderStep === 1) {
          container.innerHTML = `
            <h4 style="margin: 8px 0;">Step 1: Choose Function</h4>
            <select id="builder-function" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 12px;">
              <option value="DSIQ">DSIQ (Full Array)</option>
              <option value="DSIQ_LATEST">DSIQ_LATEST (Latest Value)</option>
              <option value="DSIQ_VALUE">DSIQ_VALUE (Specific Date)</option>
              <option value="DSIQ_YOY">DSIQ_YOY (Year-over-Year)</option>
            </select>
            <button onclick="builderNext()">Next ‚Üí</button>
          `;
        } else if (builderStep === 2) {
          container.innerHTML = `
            <h4 style="margin: 8px 0;">Step 2: Enter Series ID</h4>
            <input id="builder-series" type="text" placeholder="e.g., FRED-GDP" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 12px;" />
            <div style="display: flex; gap: 8px;">
              <button class="secondary" onclick="builderPrev()">‚Üê Back</button>
              <button onclick="builderNext()">Next ‚Üí</button>
            </div>
          `;
        } else if (builderStep === 3) {
          const needsOptions = builderConfig.functionName === 'DSIQ' || builderConfig.functionName === 'DSIQ_VALUE';
          if (needsOptions) {
            container.innerHTML = `
              <h4 style="margin: 8px 0;">Step 3: Options (Optional)</h4>
              <label>Frequency:</label>
              <input id="builder-freq" type="text" placeholder="e.g., quarterly" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 12px;" />
              <label>Start Date:</label>
              <input id="builder-start" type="text" placeholder="e.g., 2020-01-01" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 12px;" />
              <div style="display: flex; gap: 8px;">
                <button class="secondary" onclick="builderPrev()">‚Üê Back</button>
                <button onclick="builderFinish()">Insert Formula</button>
              </div>
            `;
          } else {
            builderFinish();
          }
        }
      }
      
      function builderNext() {
        if (builderStep === 1) {
          const select = document.getElementById('builder-function');
          builderConfig.functionName = select ? select.value : 'DSIQ';
        } else if (builderStep === 2) {
          const input = document.getElementById('builder-series');
          builderConfig.seriesId = input ? input.value.trim() : '';
          if (!builderConfig.seriesId) {
            showStatus('‚ö†Ô∏è Please enter a series ID');
            return;
          }
        }
        builderStep++;
        renderBuilderStep();
      }
      
      function builderPrev() {
        builderStep--;
        renderBuilderStep();
      }
      
      function builderFinish() {
        if (builderStep === 3) {
          const freqInput = document.getElementById('builder-freq');
          const startInput = document.getElementById('builder-start');
          if (freqInput) builderConfig.freq = freqInput.value.trim();
          if (startInput) builderConfig.startDate = startInput.value.trim();
        }
        
        google.script.run
          .withSuccessHandler((result) => {
            google.script.run
              .withSuccessHandler(() => {
                showStatus(`‚úÖ Inserted ${builderConfig.functionName} formula`);
                builderStep = 1;
                builderConfig = { functionName: 'DSIQ', seriesId: '', freq: '', startDate: '' };
                renderBuilderStep();
              })
              .withFailureHandler(showError)
              .insertBuilderFormula(result.formula);
          })
          .withFailureHandler(showError)
          .buildFormula(builderConfig);
      }
      
      function loadTemplatesList() {
        google.script.run
          .withSuccessHandler((tmpl) => {
            templates = tmpl || [];
            renderTemplates();
          })
          .withFailureHandler(showError)
          .getTemplates();
      }
      
      function renderTemplates() {
        const list = document.getElementById('templates-list');
        if (!templates || !templates.length) {
          list.innerHTML = '<div class="muted">No templates saved yet.</div>';
          return;
        }
        
        list.innerHTML = '';
        const ul = document.createElement('ul');
        templates.forEach((tmpl) => {
          const li = document.createElement('li');
          li.className = 'result-item';
          li.style.display = 'flex';
          li.style.justifyContent = 'space-between';
          li.style.alignItems = 'center';
          
          const info = document.createElement('div');
          const name = document.createElement('div');
          name.className = 'result-id';
          name.innerText = tmpl.name;
          const meta = document.createElement('div');
          meta.className = 'muted';
          meta.innerText = `${tmpl.formulas.length} formulas`;
          info.appendChild(name);
          info.appendChild(meta);
          
          const buttons = document.createElement('div');
          buttons.style.display = 'flex';
          buttons.style.gap = '4px';
          
          const btnLoad = document.createElement('button');
          btnLoad.className = 'insert-btn';
          btnLoad.innerText = 'üì• Load';
          btnLoad.onclick = () => loadTemplateById(tmpl.id);
          
          const btnDel = document.createElement('button');
          btnDel.className = 'secondary';
          btnDel.innerText = 'üóëÔ∏è';
          btnDel.style.padding = '6px 10px';
          btnDel.style.fontSize = '11px';
          btnDel.onclick = () => deleteTemplateById(tmpl.id);
          
          buttons.appendChild(btnLoad);
          buttons.appendChild(btnDel);
          
          li.appendChild(info);
          li.appendChild(buttons);
          ul.appendChild(li);
        });
        list.appendChild(ul);
      }
      
      function scanSheet() {
        google.script.run
          .withSuccessHandler((result) => {
            scannedFormulas = result.formulas || [];
            document.getElementById('scan-result').innerText = `Found ${scannedFormulas.length} DSIQ formulas`;
            document.getElementById('save-template-section').style.display = scannedFormulas.length > 0 ? 'block' : 'none';
          })
          .withFailureHandler(showError)
          .scanFormulas();
      }
      
      function saveTemplateNow() {
        const input = document.getElementById('template-name');
        const name = input ? input.value.trim() : '';
        if (!name) {
          showStatus('‚ö†Ô∏è Please enter a template name');
          return;
        }
        
        google.script.run
          .withSuccessHandler(() => {
            showStatus(`‚úÖ Template "${name}" saved`);
            if (input) input.value = '';
            scannedFormulas = [];
            document.getElementById('scan-result').innerText = '';
            document.getElementById('save-template-section').style.display = 'none';
            loadTemplatesList();
          })
          .withFailureHandler(showError)
          .saveTemplate(name, scannedFormulas);
      }
      
      function loadTemplateById(id) {
        google.script.run
          .withSuccessHandler(() => {
            showStatus('‚úÖ Template loaded into sheet');
          })
          .withFailureHandler(showError)
          .loadTemplate(id);
      }
      
      function deleteTemplateById(id) {
        google.script.run
          .withSuccessHandler(() => {
            showStatus('‚úÖ Template deleted');
            loadTemplatesList();
          })
          .withFailureHandler(showError)
          .deleteTemplate(id);
      }
      
      function exportTemplatesFile() {
        google.script.run
          .withSuccessHandler((result) => {
            const blob = new Blob([result.data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dsiq-templates-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showStatus('‚úÖ Templates exported to file');
          })
          .withFailureHandler(showError)
          .exportTemplates();
      }
      
      function showImportDialog() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
          const file = e.target.files ? e.target.files[0] : null;
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (event) => {
            const jsonData = event.target && event.target.result ? String(event.target.result) : '';
            google.script.run
              .withSuccessHandler((result) => {
                if (result.ok) {
                  showStatus(`‚úÖ Imported ${result.count} templates`);
                  loadTemplatesList();
                } else {
                  showStatus(`‚ùå ${result.error || 'Import failed'}`);
                }
              })
              .withFailureHandler(showError)
              .importTemplates(jsonData);
          };
          reader.readAsText(file);
        };
        input.click();
      }
      
      function toggleMultiSelect(seriesId) {
        const index = selectedForMultiInsert.indexOf(seriesId);
        if (index > -1) {
          selectedForMultiInsert.splice(index, 1);
        } else {
          selectedForMultiInsert.push(seriesId);
        }
        document.getElementById('multi-insert-btn').innerText = `Insert ${selectedForMultiInsert.length} Series`;
        document.getElementById('multi-insert-btn').style.display = selectedForMultiInsert.length > 0 ? 'block' : 'none';
      }
      
      function insertMultiple() {
        if (!selectedForMultiInsert.length) return;
        
        google.script.run
          .withSuccessHandler((result) => {
            showStatus(`‚úÖ Inserted ${result.count} series`);
            selectedForMultiInsert = [];
            document.getElementById('multi-insert-btn').style.display = 'none';
          })
          .withFailureHandler(showError)
          .insertMultipleSeries(selectedForMultiInsert, 'DSIQ_LATEST');
      }
      
      function renderSourceDropdown() {
        const select = document.getElementById('source-select');
        if (!select || !sources) return;
        select.innerHTML = '<option value="">Choose a source...</option>';
        sources.forEach(src => {
          const opt = document.createElement('option');
          opt.value = src.id;
          opt.innerText = src.name;
          select.appendChild(opt);
        });
      }
      
      function handleBrowse() {
        const select = document.getElementById('source-select');
        const source = select ? select.value : '';
        if (!source) return;
        
        document.getElementById('browse-results').innerHTML = '<div class="muted">Loading...</div>';
        google.script.run
          .withSuccessHandler((results) => {
            browseResults = results || [];
            renderBrowseResults();
          })
          .withFailureHandler(showError)
          .browseBySource(source);
      }
      
      function renderBrowseResults() {
        const container = document.getElementById('browse-results');
        if (!browseResults || !browseResults.length) {
          container.innerHTML = '<div class="muted">No results found for this source.</div>';
          return;
        }
        // Clear container completely and rebuild
        container.innerHTML = '';
        const countDiv = document.createElement('div');
        countDiv.className = 'muted';
        countDiv.style.marginBottom = '8px';
        countDiv.innerText = `Showing ${browseResults.length} series`;
        container.appendChild(countDiv);
        
        const list = document.createElement('ul');
        list.style.padding = '0';
        list.style.margin = '0';
        list.style.listStyle = 'none';
        browseResults.forEach((item) => {
          const li = document.createElement('li');
          li.className = 'result-item';
          li.innerHTML = `
            <div>
              <div class="result-id">${item.id}</div>
              <div class="result-title">${item.title || ''}</div>
            </div>
            <div class="action-buttons">
              <button class="icon-btn" onclick="showPreview('${item.id}')" title="Preview">üëÅÔ∏è</button>
              <button class="icon-btn" onclick="toggleFavorite('${item.id}')" title="Favorite">‚≠ê</button>
              <button class="icon-btn" onclick="insertSeries('${item.id}', 'DSIQ')" title="Insert Array">üìä</button>
              <button class="icon-btn" onclick="insertSeries('${item.id}', 'DSIQ_LATEST')" title="Latest Value">üìà</button>
            </div>
          `;
          list.appendChild(li);
        });
        container.appendChild(list);
      }
      
      function renderList(items, containerId, showRemove) {
        const container = document.getElementById(containerId);
        if (!items || !items.length) {
          container.innerHTML = '<div class=\"muted\">No items yet.</div>';
          return;
        }
        container.innerHTML = '';
        const list = document.createElement('ul');
        items.forEach((id) => {
          const li = document.createElement('li');
          li.className = 'result-item';
          
          const info = document.createElement('div');
          const idDiv = document.createElement('div');
          idDiv.className = 'result-id';
          idDiv.innerText = id;
          info.appendChild(idDiv);
          
          const buttons = document.createElement('div');
          buttons.className = 'result-buttons';
          
          const btnPreview = createPreviewButton(id);
          
          const isFav = favorites.includes(id);
          const btnFav = createInsertButton(isFav ? '‚≠ê' : '‚òÜ', id, null);
          btnFav.className = 'fav-btn';
          btnFav.onclick = () => toggleFavorite(id);
          
          const btnArray = createInsertButton('üìä', id, 'DSIQ');
          const btnLatest = createInsertButton('üìà', id, 'DSIQ_LATEST');
          const btnYoy = createInsertButton('üìâ', id, 'DSIQ_YOY');
          
          buttons.appendChild(btnPreview);
          buttons.appendChild(btnFav);
          buttons.appendChild(btnArray);
          buttons.appendChild(btnLatest);
          buttons.appendChild(btnYoy);
          
          li.appendChild(info);
          li.appendChild(buttons);
          list.appendChild(li);
        });
        container.appendChild(list);
      }

      function showError(err) {
        const msg = err && err.message ? err.message : 'Unexpected error';
        document.getElementById('status-banner').innerText = msg;
        document.getElementById('status-banner').classList.add('error');
      }
      
      function showStatus(msg) {
        const banner = document.getElementById('status-banner');
        banner.innerText = msg;
        banner.classList.remove('error');
      }
    </script>
  </head>
  <body onload="onLoad()">
    <h2>DataSetIQ</h2>
    <div id="status-banner" class="status"></div>
    <div id="connected-view" style="display: none">
      <div class="card">
        <div style="word-wrap: break-word; margin-bottom: 4px;"><strong>Email:</strong> <span id="user-email"></span></div>
        <div style="word-wrap: break-word; margin-bottom: 4px;"><strong>Plan:</strong> <span id="user-plan"></span></div>
        <div class="quota" style="word-wrap: break-word; margin-bottom: 8px;"><strong>Limit:</strong> <span id="user-quota"></span></div>
        <button class="secondary" onclick="disconnect()" style="width: 100%;">Disconnect API Key</button>
      </div>
      <div class="card">
        <div style="margin-bottom: 12px;">
          <div class="tabs">
            <button id="tab-search" class="tab active" onclick="switchTab('search')">üîç Search</button>
            <button id="tab-favorites" class="tab" onclick="switchTab('favorites')">‚≠ê Favorites (0)</button>
            <button id="tab-recent" class="tab" onclick="switchTab('recent')">üïí Recent (0)</button>
            <button id="tab-browse" class="tab" onclick="switchTab('browse')">üìö Browse</button>
            <button id="tab-builder" class="tab" onclick="switchTab('builder')">üîí Builder</button>
            <button id="tab-templates" class="tab" onclick="switchTab('templates')">üîí Templates</button>
          </div>
        </div>
        
        <div id="search-view">
          <label for="search-box">Search Series</label>
          <div class="row">
            <input id="search-box" type="text" placeholder='Try "FRED-GDP"' />
            <button onclick="search()">Search</button>
          </div>
          <button id="multi-insert-btn" onclick="insertMultiple()" style="display: none; width: 100%; margin: 8px 0; background: #10b981; color: #fff; padding: 10px; font-weight: 600;">Insert 0 Series</button>
          <div id="search-results" class="muted"></div>
        </div>
        
        <div id="favorites-view" style="display: none;">
          <div id="favorites-list" class="muted">No favorites yet.</div>
        </div>
        
        <div id="recent-view" style="display: none;">
          <div id="recent-list" class="muted">No recent series yet.</div>
        </div>
        
        <div id="browse-view" style="display: none;">
          <label for="source-select" style="display: block; font-weight: 600; margin-bottom: 4px;">Select Data Source</label>
          <select id="source-select" onchange="handleBrowse()" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 12px;">
            <option value="">Choose a source...</option>
          </select>
          <div id="browse-results" class="muted">Select a source to browse series.</div>
        
        <div id="builder-view" style="display: none;">
          <h3 style="margin: 8px 0 12px;">üîß Formula Builder Wizard</h3>
          <div id="builder-container"></div>
        </div>
        
        <div id="templates-view" style="display: none;">
          <h3 style="margin: 8px 0 12px;">üìÅ Templates</h3>
          
          <div style="margin-bottom: 16px;">
            <button onclick="scanSheet()" style="width: 100%; margin-bottom: 8px;">üîç Scan Current Sheet</button>
            <div id="scan-result" class="muted"></div>
            
            <div id="save-template-section" style="display: none; margin-top: 12px;">
              <label for="template-name">Template Name:</label>
              <input id="template-name" type="text" placeholder="e.g., Q4 Report" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 8px;" />
              <button onclick="saveTemplateNow()" style="width: 100%;">üíæ Save Template</button>
            </div>
          </div>
          
          <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 16px 0;" />
          
          <div style="display: flex; gap: 8px; margin-bottom: 12px;">
            <button onclick="exportTemplatesFile()" style="flex: 1; background: #6366f1; color: #fff; padding: 8px;">üì§ Export</button>
            <button onclick="showImportDialog()" style="flex: 1; background: #8b5cf6; color: #fff; padding: 8px;">üì• Import</button>
          </div>
          
          <h4 style="margin: 8px 0;">Saved Templates</h4>
          <div id="templates-list" class="muted">No templates saved yet.</div>
        </div>
        </div>
      </div>
    </div>

    <div id="disconnected-view" style="display: none">
      <div class="card">
        <label for="api-key">API Key</label>
        <input id="api-key" type="text" placeholder="Enter your DataSetIQ API key" />
        <button onclick="saveKey()">Connect Account</button>
        <div class="muted">Find your key at datasetiq.com/dashboard/api-keys.</div>
      </div>
      <div class="card">
        <div class="muted">
          First time? Use Extensions > DataSetIQ > Authorize to grant network access before using custom functions.
        </div>
      </div>
    </div>
    
    <div id="preview-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;" onclick="hidePreview()">
      <div style="background: #fff; border-radius: 8px; padding: 16px; max-width: 90%; max-height: 80%; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;">
          <h3 id="preview-title" style="margin: 0; font-size: 14px;"></h3>
          <button onclick="hidePreview()" style="background: transparent; color: #475569; padding: 4px 8px; font-size: 16px; cursor: pointer; border: none; border-radius: 4px;">‚úï</button>
        </div>
        <div id="preview-body" style="padding: 8px 0;"></div>
      </div>
    </div>
  </body>
</html>
